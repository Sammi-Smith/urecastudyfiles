proc datasets library=work kill nolist nodetails; quit;
dm out "clear"; dm log "clear";  
*******************************************************************************
*  Copyright Rho, Inc. 2013 all rights reserved                               *
*******************************************************************************;
*******************************************************************************
* Program created using SAS version 9.1 
*
* PROGRAMMER HISTORY:
*   Programmer(s)       Date(s)         Brief Description of Modifications
*   K. Jaffee           10/25/13        Create
*   K. Jaffee           06/15/16        Add in 120-month data 
*   S. Lussier          07/05/17        Clean Log
*   S. Lussier          12/21/18        Include FEV1 overread
*******************************************************************************;

*** 1. Set-up *****************************************************************;
options nodate pageno=1 mprint nofmterr;
options orientation=landscape ls=96 ps=53 font=SASFONT 6;

*** Library, Titles (1,2) and Footnotes (1) Setup ***;
%inc "S:\RhoFED\ICAC\Studies\TemplateSetup.sas";
%TemplateSetup(/* Name of the program  */
               prog=methacholine_challenge_test,
               /* Location to save     */
               pgmpath=S:\RhoFED\ICAC\Studies\URECA\Prog\Derive,
               /* Study library to add */
               study=ureca);

*** Save program source code ***;
dm "file &gpgmpath\&gprog..sas replace";

*** 2. Main Body **************************************************************;

proc sort data=master.mc out=mc ; by studyid ; run ;
proc sort data=master.mc_v2 out=mcv2 ; by studyid ; run ;
proc sort data=master.mc_v3 out=mcv3 ; by studyid ; run ;

***Check avisits and events - make sure anything is named an actual visit ;
proc freq data=mc ;
   tables avisit*event ; 
run ;
proc freq data=mcv2 ;
   tables avisit*event ; 
run ;
proc freq data=mcv3 ;
   tables avisit*event ; 
run ;
***Check these -- as of 6/15/2016 have been fixed (data step below) ;
proc print data=mc ;
   var studyid avisit event aFormDate ; 
   where avisit="mc" or event="Methacholine Challenge" ;
run ;
proc print data=mcv2 ;
   var studyid avisit event aFormDate ; 
   where avisit="mc" or event="Methacholine Challenge" ;
run ;
proc print data=mcv3 ;
   var studyid avisit event aFormDate ; 
   where avisit="mc" or event="Methacholine Challenge" ;
run ;

***Rename variables prepare to set all versions ;
data mc2 ;
   set mc (rename=(avisit=avisit_char)) ;

   if status="missing" then delete ;

   rename 
         MC_q10a=methc_FEV1
         MC_q10b=methc_FEV1pp
         MC_q16=meth_starttime 
         MC_q19c=numsolutions
         MC_q20=reached_pc20 
         MC_q20a=pc20 ;

   keep studyid aFormDate avisit_char event MC_q10a MC_q10b MC_q16 MC_q20 MC_q20a MC_q19c;
run ;
proc freq; tables numsolutions; run;
data mcv2_2 ;
   set mcv2 (rename=(avisit=avisit_char)) ;

   if status="missing" then delete ;

   rename MC_v2_q10a=methc_FEV1
          MC_v2_q10b=methc_FEV1pp
          MC_v2_q16=meth_starttime 
          MC_v2_q19c=numsolutions
          MC_v2_q20=reached_pc20 
          MC_v2_q20a=pc20 ;

   keep studyid aFormDate avisit_char event MC_v2_q10a MC_v2_q10b MC_v2_q16 MC_v2_q20 MC_v2_q20a MC_v2_q19c;
run ;

data mcv3_2 ;
   set mcv3 (rename=(avisit=avisit_char)) ;

   if status="missing" then delete ;

   rename MC_v3_q10a=methc_FEV1
          MC_v3_q10b=methc_FEV1pp
          MC_v3_q16=meth_starttime 
          MC_v3_q19c=numsolutions
          MC_v3_q20=reached_pc20 
          MC_v3_q20a=pc20 ;

   keep studyid aFormDate avisit_char event MC_v3_q10a MC_v3_q10b MC_v3_q16 MC_v3_q20 MC_v3_q20a MC_v3_q19c;
run ;

***Stack all 3 and manually code the MCs to be visits that are appropriate ;
data mc_stack ;
   set mc2 mcv2_2 mcv3_2 ;

   ***Rename all where avisit="mc" to be appropriate visit code - fixing the 13 we printed above ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
/*   end ;*/
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;
*hardcodes here have been removed to protect patient confidentiality;
   end ;

run ;

***Double check that there are no avisit_char = "mc" ;
proc freq data=mc_stack ;
   tables avisit_char ;
run ;
proc print data=mc_stack ;
   var studyid avisit_char event aFormDate ; 
   where avisit_char="mc" or event="Methacholine Challenge" ;
run ;

data mc_stack2 ;
   set mc_stack ;

   avisit = input(put(avisit_char,$8.),8.) ;
    avisit_actual=avisit ;

   ***Just call every 84m visit 81m since they are only supposed to have 1, and its easier to merge ;
   if avisit=84 then avisit=81;

   ***A lot of visits had to be re-done, so lots of dup IDs+visits - get rid of any visits where metha 
      not completed ;
   if meth_starttime<0 then delete ;

   ***A few duplicates (8, complete for 81/84/120) where child made it all the way to MC challenge but something happened and no PC20 val ;
*hardcodes here have been removed to protect patient confidentiality;

run ;

***Check as of 6/15/2016 should be complete data now - there are 8 dups that need addressing (fixed in above datastep) so this should yield nothing ;
proc sort data=mc_stack2 out=mc_clean nodupkey dupout=dups ; by studyid avisit ; run ;

***Incorporate overreading data -- for pc20 only;
*add in overreading for FEV1;
proc sort data=master.mcor out=mcor ; by studyid ; run ;
proc sort data=master.mcor_v2 out=mcor2 ; by studyid ; run ;

data mcor_2;
set mcor;
   rename 
          MCOR_q11=meth_analysis 
          MCOR_q11l=methc_pc20_acc 
          MCOR_q11l1=methc_pc20_orval
          MCOR_q11m1 = methc_fev1_or;

   keep studyid event aformdate MCOR_q11 MCOR_q11l MCOR_q11l1 MCOR_q11m1;
   run;

data mcor2_2;
set mcor2;
   rename 
          MCOR_v2_q11=meth_analysis 
          MCOR_v2_q11l=methc_pc20_acc 
          MCOR_v2_q11l1=methc_pc20_orval
          MCOR_q11m1 = methc_fev1_or;

   keep studyid event aformdate MCOR_v2_q11 MCOR_v2_q11l MCOR_v2_q11l1 MCOR_q11m1;
   run;

***Merge two form versions;
data mcor_all ;
set mcor_2 mcor2_2;
RUN;

***Check as of 5/09/2017 should be complete data now - there are 10 that need fixing (in below datastep) ;
proc print data=mcor_all ;
   var studyid  event aFormDate ; 
   where event="Methacholine Challenge" ;
run ;

data mcor_all2 ;
   set mcor_all ;

   ***If event="Methacholine Challenge" change it to the actual visit so we can merge with meth data  - fixing the 5 printed above ;
*hardcodes here have been removed to protect patient confidentiality;

   ***They did this at m81 and shouldnt have done it again at m84 - didn't complete at either visit ;
*hardcodes here have been removed to protect patient confidentiality;

   *** This was re-done at 84m so delete the 81m ;
*hardcodes here have been removed to protect patient confidentiality;

   *** This was a mistake by the overreader, but the participant got all 10 doses,corrections were needed to FVC values, but not pc20;
*hardcodes here have been removed to protect patient confidentiality; end;
   
   avisit_actual=input(scan(event, 1, '-'),3.);

run ;

/*proc freq data=mcor2; tables meth_analysis * methc_pc20_acc * methc_pc20_orval/list missing; run;

proc print data=mcor2; var studyid event avisit_actual meth_analysis methc_pc20_acc methc_pc20_orval;
where meth_analysis=2 and methc_pc20_acc=.a and methc_pc20_orval=0; run;*/

proc sort data=mcor_all2 ; by studyid avisit_actual ; run ;
proc sort data=mc_clean ; by studyid avisit_actual ; run ;

data methacholine_challenge00 ;
   merge mcor_all2 mc_clean(in=b) ;
   by studyid avisit_actual ; 

   ***Keep if it's in the actual meth dataset, not just in the OR dataset;
   if b=1 ;

   ***overread FEV1;
   if methc_fev1_or >0 then methc_fev1 = methc_fev1_or;
      else methc_fev1=methc_fev1;

   ***There are 3 participants where they reached PC20 but they do not have a value noted - 
      below 2 pts have FEV1 < 80% post diluent so we can call these kids pc20 = 0 ;
*hardcodes here have been removed to protect patient confidentiality;
      *unfortunately, this is a wash and we will not be able to call this person > or < 4 and it will remain missing ;

   ***This was a duplicate, the only difference was that there is one record with missing overreading data, deleting it here ;
*hardcodes here have been removed to protect patient confidentiality;
   ***This was a duplicate, the only difference was between whether OR corrected or site was correct, values dont affect anything so deleting it here ;
*hardcodes here have been removed to protect patient confidentiality;

   ***This is cutoff decided by L Bacharier (4) may be changed later ;
   if reached_pc20=1 then do ;
      if pc20 > 4 then pc20_high=1 ;
      if 0<=pc20 <= 4 then pc20_high=0 ;
   end ;
   if reached_pc20=0 and numsolutions=10 then pc20_high=1 ;

   ***Recoded and renamed by C Visness to reduce confusion - 09 MAY 2017 ;
   if reached_pc20=1 then do ;
      if pc20 > 4 then pc20_le4=0 ;
      if 0<=pc20 <= 4 then pc20_le4=1 ;
   end ;
   if reached_pc20=0 and numsolutions=10 then pc20_le4=0 ;

   ***Call this 25 for now, but may change later. ;
   if reached_pc20=0 and numsolutions=10 then pc20=25 ; 

   if meth_analysis in (1,2) then meth_acceptable=1 ;
   if meth_analysis=3 then meth_acceptable=0 ;

   if meth_analysis=2 then do ;
      if methc_pc20_orval>=0 then pc20=methc_pc20_orval ;
      else pc20=pc20 ;
   end ;

   label pc20_high="PC20 greater than 4? (0=no, 1=yes)" 
         pc20_le4="PC20 less than or equal to 4? (0=no, 1=yes)" ;
   drop avisit_char ;

   ***1/2/18 change 81 to 84;
   if avisit = 81 then avisit = 84;
run ;


***Deleting actual true duplicates (4);
proc sort data=methacholine_challenge00 out=methacholine_challenge01 nodup ; by studyid ; run ;

***No duplicates as of 2/03/2017 (only 2 taken care of above);
proc sort data=methacholine_challenge01 out=methacholine_challenge02 dupout=dups_mc02 nodupkey ; by studyid avisit ; run ;

***2/03/2017 - there are 4 of these cases for 81/84/120 m - this will stay missing ;
proc print data=methacholine_challenge02 ;
   var studyid avisit pc20 pc20_high reached_pc20 ;
   where pc20_high=. and reached_pc20=1 ;
run ;

proc print data=methacholine_challenge02 ;
   var studyid avisit pc20 pc20_high reached_pc20 numsolutions meth_acceptable meth_analysis methc_pc20_acc methc_pc20_orval;
   where pc20 <= .z ;
run ;

proc print data=methacholine_challenge02 ;
   var studyid avisit pc20 pc20_high reached_pc20 numsolutions meth_acceptable meth_analysis methc_pc20_acc methc_pc20_orval;
   where pc20_high=. ;
run ;

proc freq data=methacholine_challenge02 ;
tables reached_pc20 * numsolutions * pc20_high * pc20/list missing;
format pc20 2.;
run;

proc print data=methacholine_challenge02 ;
   var studyid avisit pc20 pc20_high reached_pc20 numsolutions meth_acceptable meth_analysis methc_pc20_acc methc_pc20_orval;
   where reached_pc20 =1 and numsolutions=.a ;
run ;
**These are kids that reacted at the diluent stage;

/*************************************************************************************
 Create Shell
**************************************************************************************/
data shell81;
 set derive.groups;

 site=substr(studyid, 4, 2);
 label    site="Study Site";
 format site $site.;

 do avisit = 84, 120;
  if avisit in (84) then year=7;
  if avisit in (120) then year=10;
 output;
 end ;
 keep studyid recruitid site avisit year ;
run;

/*************************************************************************************
 Merge and derive
**************************************************************************************/
proc sort data=shell81; by studyid avisit; run;
proc sort data=methacholine_challenge02 ;  by studyid avisit; run;

data derive.methacholine_challenge ;
   merge shell81 methacholine_challenge02(in=a);
   by studyid avisit ;
   if a=1 then methacholine_challenge=1 ;
   if a=0 then methacholine_challenge=0 ;

   label meth_acceptable = 'Methacholine challenge results acceptable';
run ;

*** Codebook ****************************************************************;

%include 'S:\BASESTAT\RhoUtil\gitGot.sas';
    %gitGot
        (repo = https://github.com/RhoInc/sas-codebook
        ,folder = Macros);

%codebook_generic
        (data = derive.methacholine_challenge
        ,pdfpath = S:/RhoFED/ICAC/Studies/URECA/Data/Derive/CBK);


ods select Position;
proc contents data=derive.methacholine_challenge position; run;
run;
ods select default;