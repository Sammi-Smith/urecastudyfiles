
proc sort data=meds10; by studyid year avisit; run;
proc sort data=meds10 out=medsyr20; by year; run;

*Do some additional data checking;
proc means data=medsyr20;
   var albut_broncho -- other_route_unknown;
   by year;
run;

proc freq data=medsyr20;
   tables albut_broncho -- other_route_unknown ;
   by year;
run;

*Check for participants with missing studyid - should not be any!;
proc print data=medsyr20; where studyid in (' '); run;
proc sort data=master.p_study_data out=pdata (keep=recruitid studyid p_status); where p_status in ('active','inactive'); by studyid; run;
proc print data=pdata; where studyid in (' '); run;

proc sort data=medsyr20; by studyid; run;

data medsyr30 nomedsyr;
 merge pdata medsyr20;
  by studyid;

  *output a dataset for participants who did not report any meds;
  if medcode = . then output nomedsyr;
  else output medsyr30;
run;

*macro to create yearly rows for participants with no meds;
%macro create_rows(yr);

data nomedsyr&yr;
 set nomedsyr;

 year = &yr.;

 albut_broncho = 0;
 analgesics_oral= 0;
 analgesics_topical = 0;
 antibiot_oral = 0;
 antibiot_topical = 0;
 antifung_oral = 0;
 antifung_topical = 0; 
 antihist_oral = 0; 
 antihist_topical = 0; 
 antileuk = 0;
 cough_meds = 0; 
 cromones = 0;
 decongest = 0;
 gi_meds = 0;
 LABA = 0;
 nasalspray_noster = 0;
 nasalspray_ster = 0;
 steroid_inhaled = 0;
 steroid_oral = 0;
 steroid_topical = 0;
 ophthals = 0;
 otological = 0;
 epinephrine = 0;
 vitamin = 0;
 antiviral_oral = 0;
 inhaled_steroid_LABA = 0;
 combo_antihist = 0;
 combo_nonantihist = 0;
 cold_preps = 0;
 other_topical = 0;
 other_inhale = 0;
 other_oral = 0;
 other_route_unknown = 0;

run;

%mend;

%create_rows(1);
%create_rows(2);
%create_rows(3);
%create_rows(4);
%create_rows(5);
%create_rows(6);
%create_rows(7);
%create_rows(8);
%create_rows(9);
%create_rows(10);

*Set the years of data per participant together;
data nomedsyr00;
 set nomedsyr1 nomedsyr2 nomedsyr3 nomedsyr4 nomedsyr5 nomedsyr6 nomedsyr7
 nomedsyr8 nomedsyr9 nomedsyr10;
run;

*Now put all the meds and nomeds rows back together;
data medsyr40;
 set medsyr30 nomedsyr00;
run;

*Sort and keep only one row per participant per year;
*To prepare dataset for creating rows for participants who did not report meds for each year in dataset;
proc sort data=medsyr40 out=medsyr50 nodupkey; by studyid year; run;

*Transpose to see what we have;
proc transpose data=medsyr50  (keep=studyid year) out=medsyr50t;
 by studyid;
run;

*Now begins the repetitive task of creating rows;
data medsyr60 compyears incompyears;
 set medsyr50t;

 *if all transposed columns contain a value then participant has meds reported for each year;
 *otherwise, output all participants who do not have complete data;
 *NOTE: this code will have to be updated once additional years of data are added;
 *Otherwise, may need to come up with a different way of handling this!!!;
 if col1=1 and col2=2 and col3=3 and col4=4 and col5=5 and col6=6 and col7=7 and 
    col8=8 and col9=9 and col10=10 then output compyears;
 else output incompyears;
run;

 
data incompyears1;
 set incompyears;
  where col1 ne 1;

 year = 1;

 albut_broncho = 0;
 analgesics_oral= 0;
 analgesics_topical = 0;
 antibiot_oral = 0;
 antibiot_topical = 0;
 antifung_oral = 0;
 antifung_topical = 0; 
 antihist_oral = 0; 
 antihist_topical = 0; 
 antileuk = 0;
 cough_meds = 0; 
 cromones = 0;
 decongest = 0;
 gi_meds = 0;
 LABA = 0;
 nasalspray_noster = 0;
 nasalspray_ster = 0;
 steroid_inhaled = 0;
 steroid_oral = 0;
 steroid_topical = 0;
 ophthals = 0;
 otological = 0;
 epinephrine = 0;
 vitamin = 0;
 antiviral_oral = 0;
 inhaled_steroid_LABA = 0;
 combo_antihist = 0;
 combo_nonantihist = 0;
 cold_preps = 0;
 other_topical = 0;
 other_inhale = 0;
 other_oral = 0;
 other_route_unknown = 0;
run;


data incompyears2;
 set incompyears;
  where col1 ne 2 and col2 ne 2;

 year = 2;

 albut_broncho = 0;
 analgesics_oral= 0;
 analgesics_topical = 0;
 antibiot_oral = 0;
 antibiot_topical = 0;
 antifung_oral = 0;
 antifung_topical = 0; 
 antihist_oral = 0; 
 antihist_topical = 0; 
 antileuk = 0;
 cough_meds = 0; 
 cromones = 0;
 decongest = 0;
 gi_meds = 0;
 LABA = 0;
 nasalspray_noster = 0;
 nasalspray_ster = 0;
 steroid_inhaled = 0;
 steroid_oral = 0;
 steroid_topical = 0;
 ophthals = 0;
 otological = 0;
 epinephrine = 0;
 vitamin = 0;
 antiviral_oral = 0;
 inhaled_steroid_LABA = 0;
 combo_antihist = 0;
 combo_nonantihist = 0;
 cold_preps = 0;
 other_topical = 0;
 other_inhale = 0;
 other_oral = 0;
 other_route_unknown = 0;
run;


data incompyears3;
 set incompyears;
  where col1 ne 3 and col2 ne 3 and col3 ne 3;

 year = 3;

 albut_broncho = 0;
 analgesics_oral= 0;
 analgesics_topical = 0;
 antibiot_oral = 0;
 antibiot_topical = 0;
 antifung_oral = 0;
 antifung_topical = 0; 
 antihist_oral = 0; 
 antihist_topical = 0; 
 antileuk = 0;
 cough_meds = 0; 
 cromones = 0;
 decongest = 0;
 gi_meds = 0;
 LABA = 0;
 nasalspray_noster = 0;
 nasalspray_ster = 0;
 steroid_inhaled = 0;
 steroid_oral = 0;
 steroid_topical = 0;
 ophthals = 0;
 otological = 0;
 epinephrine = 0;
 vitamin = 0;
 antiviral_oral = 0;
 inhaled_steroid_LABA = 0;
 combo_antihist = 0;
 combo_nonantihist = 0;
 cold_preps = 0;
 other_topical = 0;
 other_inhale = 0;
 other_oral = 0;
 other_route_unknown = 0;
run;


data incompyears4;
 set incompyears;
  where col1 ne 4 and col2 ne 4 and col3 ne 4 and col4 ne 4;

 year = 4;

 albut_broncho = 0;
 analgesics_oral= 0;
 analgesics_topical = 0;
 antibiot_oral = 0;
 antibiot_topical = 0;
 antifung_oral = 0;
 antifung_topical = 0; 
 antihist_oral = 0; 
 antihist_topical = 0; 
 antileuk = 0;
 cough_meds = 0; 
 cromones = 0;
 decongest = 0;
 gi_meds = 0;
 LABA = 0;
 nasalspray_noster = 0;
 nasalspray_ster = 0;
 steroid_inhaled = 0;
 steroid_oral = 0;
 steroid_topical = 0;
 ophthals = 0;
 otological = 0;
 epinephrine = 0;
 vitamin = 0;
 antiviral_oral = 0;
 inhaled_steroid_LABA = 0;
 combo_antihist = 0;
 combo_nonantihist = 0;
 cold_preps = 0;
 other_topical = 0;
 other_inhale = 0;
 other_oral = 0;
 other_route_unknown = 0;
run;


data incompyears5;
 set incompyears;
  where col1 ne 5 and col2 ne 5 and col3 ne 5 and col4 ne 5 and col5 ne 5;

 year = 5;

 albut_broncho = 0;
 analgesics_oral= 0;
 analgesics_topical = 0;
 antibiot_oral = 0;
 antibiot_topical = 0;
 antifung_oral = 0;
 antifung_topical = 0; 
 antihist_oral = 0; 
 antihist_topical = 0; 
 antileuk = 0;
 cough_meds = 0; 
 cromones = 0;
 decongest = 0;
 gi_meds = 0;
 LABA = 0;
 nasalspray_noster = 0;
 nasalspray_ster = 0;
 steroid_inhaled = 0;
 steroid_oral = 0;
 steroid_topical = 0;
 ophthals = 0;
 otological = 0;
 epinephrine = 0;
 vitamin = 0;
 antiviral_oral = 0;
 inhaled_steroid_LABA = 0;
 combo_antihist = 0;
 combo_nonantihist = 0;
 cold_preps = 0;
 other_topical = 0;
 other_inhale = 0;
 other_oral = 0;
 other_route_unknown = 0;
run;

data incompyears6;
 set incompyears;
  where col1 ne 6 and col2 ne 6 and col3 ne 6 and col4 ne 6 and col5 ne 6 and col6 ne 6;

 year = 6;

 albut_broncho = 0;
 analgesics_oral= 0;
 analgesics_topical = 0;
 antibiot_oral = 0;
 antibiot_topical = 0;
 antifung_oral = 0;
 antifung_topical = 0; 
 antihist_oral = 0; 
 antihist_topical = 0; 
 antileuk = 0;
 cough_meds = 0; 
 cromones = 0;
 decongest = 0;
 gi_meds = 0;
 LABA = 0;
 nasalspray_noster = 0;
 nasalspray_ster = 0;
 steroid_inhaled = 0;
 steroid_oral = 0;
 steroid_topical = 0;
 ophthals = 0;
 otological = 0;
 epinephrine = 0;
 vitamin = 0;
 antiviral_oral = 0;
 inhaled_steroid_LABA = 0;
 combo_antihist = 0;
 combo_nonantihist = 0;
 cold_preps = 0;
 other_topical = 0;
 other_inhale = 0;
 other_oral = 0;
 other_route_unknown = 0;
run;

data incompyears7;
 set incompyears;
  where col1 ne 7 and col2 ne 7 and col3 ne 7 and col4 ne 7 and col5 ne 7 and col6 ne 7 and col7 ne 7;

 year = 7;

 albut_broncho = 0;
 analgesics_oral= 0;
 analgesics_topical = 0;
 antibiot_oral = 0;
 antibiot_topical = 0;
 antifung_oral = 0;
 antifung_topical = 0; 
 antihist_oral = 0; 
 antihist_topical = 0; 
 antileuk = 0;
 cough_meds = 0; 
 cromones = 0;
 decongest = 0;
 gi_meds = 0;
 LABA = 0;
 nasalspray_noster = 0;
 nasalspray_ster = 0;
 steroid_inhaled = 0;
 steroid_oral = 0;
 steroid_topical = 0;
 ophthals = 0;
 otological = 0;
 epinephrine = 0;
 vitamin = 0;
 antiviral_oral = 0;
 inhaled_steroid_LABA = 0;
 combo_antihist = 0;
 combo_nonantihist = 0;
 cold_preps = 0;
 other_topical = 0;
 other_inhale = 0;
 other_oral = 0;
 other_route_unknown = 0;
run;

data incompyears8;
 set incompyears;
  where col1 ne 8 and col2 ne 8 and col3 ne 8 and col4 ne 8 and col5 ne 8 and col6 ne 8 and col7 ne 8 and col8 ne 8;

 year = 8;

 albut_broncho = 0;
 analgesics_oral= 0;
 analgesics_topical = 0;
 antibiot_oral = 0;
 antibiot_topical = 0;
 antifung_oral = 0;
 antifung_topical = 0; 
 antihist_oral = 0; 
 antihist_topical = 0; 
 antileuk = 0;
 cough_meds = 0; 
 cromones = 0;
 decongest = 0;
 gi_meds = 0;
 LABA = 0;
 nasalspray_noster = 0;
 nasalspray_ster = 0;
 steroid_inhaled = 0;
 steroid_oral = 0;
 steroid_topical = 0;
 ophthals = 0;
 otological = 0;
 epinephrine = 0;
 vitamin = 0;
 antiviral_oral = 0;
 inhaled_steroid_LABA = 0;
 combo_antihist = 0;
 combo_nonantihist = 0;
 cold_preps = 0;
 other_topical = 0;
 other_inhale = 0;
 other_oral = 0;
 other_route_unknown = 0;
run;

data incompyears9;
 set incompyears;
  where col1 ne 9 and col2 ne 9 and col3 ne 9 and col4 ne 9 and col5 ne 9 and col6 ne 9 and col7 ne 9 and col8 ne 9 and col9 ne 9;

 year = 9;

 albut_broncho = 0;
 analgesics_oral= 0;
 analgesics_topical = 0;
 antibiot_oral = 0;
 antibiot_topical = 0;
 antifung_oral = 0;
 antifung_topical = 0; 
 antihist_oral = 0; 
 antihist_topical = 0; 
 antileuk = 0;
 cough_meds = 0; 
 cromones = 0;
 decongest = 0;
 gi_meds = 0;
 LABA = 0;
 nasalspray_noster = 0;
 nasalspray_ster = 0;
 steroid_inhaled = 0;
 steroid_oral = 0;
 steroid_topical = 0;
 ophthals = 0;
 otological = 0;
 epinephrine = 0;
 vitamin = 0;
 antiviral_oral = 0;
 inhaled_steroid_LABA = 0;
 combo_antihist = 0;
 combo_nonantihist = 0;
 cold_preps = 0;
 other_topical = 0;
 other_inhale = 0;
 other_oral = 0;
 other_route_unknown = 0;
run;

data incompyears10;
 set incompyears;
  where col1 ne 10 and col2 ne 10 and col3 ne 10 and col4 ne 10 and col5 ne 10 and col6 ne 10 and col7 ne 10 and 
        col8 ne 10 and col9 ne 10;

 year = 10;

 albut_broncho = 0;
 analgesics_oral= 0;
 analgesics_topical = 0;
 antibiot_oral = 0;
 antibiot_topical = 0;
 antifung_oral = 0;
 antifung_topical = 0; 
 antihist_oral = 0; 
 antihist_topical = 0; 
 antileuk = 0;
 cough_meds = 0; 
 cromones = 0;
 decongest = 0;
 gi_meds = 0;
 LABA = 0;
 nasalspray_noster = 0;
 nasalspray_ster = 0;
 steroid_inhaled = 0;
 steroid_oral = 0;
 steroid_topical = 0;
 ophthals = 0;
 otological = 0;
 epinephrine = 0;
 vitamin = 0;
 antiviral_oral = 0;
 inhaled_steroid_LABA = 0;
 combo_antihist = 0;
 combo_nonantihist = 0;
 cold_preps = 0;
 other_topical = 0;
 other_inhale = 0;
 other_oral = 0;
 other_route_unknown = 0;
run;
 
*Put the dataset back together again and drop variables that are no longer complete;
data medsyr70; 
 set medsyr40 incompyears1 incompyears2 incompyears3 incompyears4 incompyears5 incompyears6 incompyears7
    incompyears8 incompyears9 incompyears10;

 drop p_status recruitid _name_ col1-col10;
run;

proc sort data=medsyr70; by studyid year; run;

*Summarize meds by year;
data medsyr80 year1 year2 year3 year4 year5 year6 year7 year8 year9 year10;
 set medsyr70;

 *if no meds reported then output to a separate dataset;
 *otherwise, output year-specific datasets;
 if event in (' ') and medcode in (.) then output medsyr80;
 if year=1 then output year1;
 if year=2 then output year2;
 if year=3 then output year3;
 if year=4 then output year4;
 if year=5 then output year5;
 if year=6 then output year6;
 if year=7 then output year7;
 if year=8 then output year8;
 if year=9 then output year9;
 if year=10 then output year10;
run;

*Macro to create year and drug specific datasets;
*Purpose is to flag whether or not a particular drug was taken in the given year;
*Macro to be called for each drug type and year;
%macro drugtypes(yr,drugtp);
data year &drugtp&yr;
 set year&yr;

 *no longer need medcode, drugname, and event variables;
 keep studyid &drugtp year;

 if &drugtp = 1 then output &drugtp&yr;
run;

*only keep one row per participant since repeating rows not necessary;
proc sort data=&drugtp&yr nodupkey; by studyid; run;
%mend;

%macro DoDrugTypes();
 %do i=1 %to 10;
%drugtypes(&i.,albut_broncho);
%drugtypes(&i.,analgesics_oral);
%drugtypes(&i.,analgesics_topical);
%drugtypes(&i.,antibiot_oral);
%drugtypes(&i.,antibiot_topical);
%drugtypes(&i.,antifung_oral);
%drugtypes(&i.,antifung_topical); 
%drugtypes(&i.,antihist_oral); 
%drugtypes(&i.,antihist_topical); 
%drugtypes(&i.,antileuk);
%drugtypes(&i.,cough_meds); 
%drugtypes(&i.,cromones);
%drugtypes(&i.,decongest);
%drugtypes(&i.,gi_meds);
%drugtypes(&i.,LABA);
%drugtypes(&i.,nasalspray_noster);
%drugtypes(&i.,nasalspray_ster);
%drugtypes(&i.,steroid_inhaled);
%drugtypes(&i.,steroid_oral);
%drugtypes(&i.,steroid_topical);
%drugtypes(&i.,ophthals);
%drugtypes(&i.,otological);
%drugtypes(&i.,epinephrine);
%drugtypes(&i.,vitamin);
%drugtypes(&i.,antiviral_oral);
%drugtypes(&i.,inhaled_steroid_LABA);
%drugtypes(&i.,combo_antihist);
%drugtypes(&i.,combo_nonantihist);
%drugtypes(&i.,cold_preps);
%drugtypes(&i.,other_topical);
%drugtypes(&i.,other_inhale);
%drugtypes(&i.,other_oral);
%drugtypes(&i.,other_route_unknown);

data year&i._00;
 merge albut_broncho&i. analgesics_oral&i. analgesics_topical&i. antibiot_oral&i. antibiot_topical&i. antifung_oral&i. antifung_topical&i.
       antihist_oral&i. antihist_topical&i. antileuk&i. cough_meds&i. cromones&i. decongest&i. gi_meds&i. LABA&i. nasalspray_noster&i. nasalspray_ster&i.
       steroid_inhaled&i. steroid_oral&i. steroid_topical&i. ophthals&i. otological&i. epinephrine&i. vitamin&i. antiviral_oral&i. 
       inhaled_steroid_LABA&i. combo_antihist&i. 
       combo_nonantihist&i. cold_preps&i. other_topical&i. other_inhale&i. other_oral&i. other_route_unknown&i.;
by studyid;
run;

%end;
%mend;

%DoDrugTypes();


*Now set the yearly datasets back together and create yes/no variables and label them;
data medsyr90;
 set year1_00 year2_00 year3_00 year4_00 year5_00 year6_00 year7_00 year8_00 year9_00 year10_00;

 albut_broncho = albut_broncho in (1);
 analgesics_oral = analgesics_oral in (1);
 analgesics_topical = analgesics_topical in (1);
 antibiot_oral = antibiot_oral in (1);
 antibiot_topical = antibiot_topical in (1);
 antifung_oral = antifung_oral in (1);
 antifung_topical = antifung_topical in (1); 
 antihist_oral = antihist_oral in (1); 
 antihist_topical = antihist_topical in (1); 
 antileuk = antileuk in (1);
 cough_meds = cough_meds in (1); 
 cromones = cromones in (1);
 decongest = decongest in (1);
 gi_meds = gi_meds in (1);
 LABA = LABA in (1);
 nasalspray_noster = nasalspray_noster in (1);
 nasalspray_ster = nasalspray_ster in (1);
 steroid_inhaled = steroid_inhaled in (1);
 steroid_oral = steroid_oral in (1);
 steroid_topical = steroid_topical in (1);
 ophthals = ophthals in (1);
 otological = otological in (1);
 epinephrine = epinephrine in (1);
 vitamin = vitamin in (1);
 antiviral_oral = antiviral_oral in (1);
 inhaled_steroid_LABA = inhaled_steroid_LABA in (1); 
 combo_antihist = combo_antihist in (1);
 combo_nonantihist = combo_nonantihist in (1);
 cold_preps = cold_preps in (1);
 other_topical = other_topical in (1);
 other_inhale = other_inhale in (1);
 other_oral = other_oral in (1);
 other_route_unknown = other_route_unknown in (1);

label albut_broncho = "Albuterol/Short-acting bronchodilator" 
     analgesics_oral = "Analgesics/antipyretics - oral"
     analgesics_topical = "Analgesics/antipyretics - topical"
     antibiot_oral = "Antibiotics - oral"
     antibiot_topical = "Antibiotics - topical" 
     antifung_oral = "Anti-fungals - oral/systemic" 
     antifung_topical = "Anti-fungals - topical"
     antihist_oral = "Antihistamines - oral"
     antihist_topical = "Antihistamines - topical"
     antileuk = "Anti-leukotrienes (montelukast, zafirlukast, zileuton)"
     cough_meds = "Cough medicine"
     cromones = "Cromones"
     decongest = "Decongestants"
     gi_meds = "GI medications (pepto-bismol, maalox)"
     LABA = "Long-acting beta agonist (LABA)"
     nasalspray_noster = "Nasal spray - non-steroidal"
     nasalspray_ster = "Nasal spray - steroidal" 
     steroid_inhaled = "Steroids - inhaled"
     steroid_oral = "Steroids - oral"
     steroid_topical = "Steroids - topical" 
     ophthals = "Ophthalmologicals"
     otological = "Otologicals"
      epinephrine = "Epinephrine/Epipen"
     vitamin = "Vitamins/Nutritionals"
     antiviral_oral = "Anti-virals - oral"
     inhaled_steroid_LABA = "Combination inhaled steroid + LABA"
      combo_antihist = "Combination products with antihistamine"
     combo_nonantihist = "Cominbation products without antihistamine"
     cold_preps = "Cold preparations - unspecified"
      other_topical = "Other products - topical"
     other_inhale = "Other products - inhaled"
     other_oral = "Other products - oral" 
     other_route_unknown = "Other products - other or unknown route"
      year = "Event Year";

     format albut_broncho analgesics_oral analgesics_topical antibiot_oral antibiot_topical antifung_oral 
             antifung_topical antihist_oral antihist_topical antileuk cough_meds cromones decongest gi_meds 
            LABA nasalspray_noster nasalspray_ster steroid_inhaled steroid_oral steroid_topical ophthals 
             otological epinephrine vitamin antiviral_oral inhaled_steroid_LABA combo_antihist combo_nonantihist 
            cold_preps other_topical other_inhale other_oral other_route_unknown yesnofm.;
run;

*Add the rows with no medications indications back in;
*Do not need event medcode or drugname variables since they were blank anyway;
data medsyr100;
 set medsyr80 (drop=event medcode drugname) medsyr90;

run;

proc sort data=medsyr100; by studyid year; run;

*Create derived dataset and put recruitid and participant status back on the dataset;
data derive.meduse_byyear;
 merge pdata medsyr100;
 by studyid;
run;

proc sort data=derive.meduse_byyear out=meduse_byyear; by year; run;

*Do some additional data checking;
proc means data=meduse_byyear;
   var albut_broncho -- other_route_unknown;
   by year;
run;

proc freq data=meduse_byyear;
   tables albut_broncho -- other_route_unknown ;
   by year;
run;

*ods rtf style=journal file="S:\RhoFED\ICAC\Studies\URECA\Prog\Derive\ThreeYearAnalyses\MedUse_by_Year_Freq.rtf" notoc_data;
proc freq data=meduse_byyear;
   tables albut_broncho -- other_route_unknown * year/norow;
run;
*ods rtf close;

proc contents data=derive.meduse_byyear; run;

*Code to flag years following a participant being documented as inactive in the study;
proc sort data=derive.meduse_byyear out=parts (keep=studyid) nodupkey; by studyid;
where p_status in ('inactive','active'); run;

proc sql;
 create table events as
 select * 
 from master.eset as e, parts as i
 where e.studyid=i.studyid
 ;
quit;

proc sort data=events; by studyid; run;

data events00;
 set events;

*Get or calculate visit date;
if date_occurred>.z then date=date_occurred;
else if date_scheduled>.z then date=date_scheduled;
else if n(date_start_window, date_end_window)=2 then date=mean(date_start_window, date_end_window);
else date=max(date_start_window, date_end_window);

 if substr(event,2,6)="-month" then do;
   eventn=substr(event,1,1)*1;
   event="Event0"||substr(event,1,1);
 end;
 else if substr(event,3,6)="-month" then do;
   eventn=substr(event,1,2)*1;
   event="Event"||substr(event,1,2);
 end;
 else if event in ("deactivation event") then do 
   event="Deact";
   eventn=99;
 end;
 else delete;

 format date mmddyy8.;

 drop id parent_id visit_notes date_occurred date_scheduled date_start_window date_end_window time_scheduled time_occurred;
run;

proc sort data=events00 out=events10; by studyid date descending event; run;


*get last occurred visit for each participant;
data lastevent;
set events10;
by studyid;
retain last lastn deact;

if first.studyid then do;
  last="        ";
  lastn=.;
  deact=0;
end;

if event ne "deact" and status="occurred" then do;
  last=event;
  lastn=eventn;
end;
if event="Deact" then deact=1;

if last.studyid then output;

keep studyid deact last lastn;
run;

proc freq; tables deact; run;

*get last occurred visit prior to deactivation;
data prior_to_deact;
 set events10;
  where status eq "occurred";
  by studyid;

retain prev "       " prevn; 
if first.studyid then do;
 prev="       ";
 prevn=0;
end;

if event="Deact" then output;

prev=event;
prevn=eventn;

keep studyid prevn;
run;

data prior_to_deact10;
 set prior_to_deact;

if prevn in (0) then last_year=0;
if prevn in (3,6,9,12) then last_year=1;
if prevn in (15,18,21,24) then last_year=2;
if prevn in (27,30,33,36) then last_year=3;
if prevn in (39,42,45,48) then last_year=4;
if prevn in (51,54,57,60) then last_year=5;
if prevn in (63,66,69,72) then last_year=6;
if prevn in (75,78,81,84) then last_year=7;
if prevn in (87,90,93,96) then last_year=8;
if prevn in (99,102,105,108) then last_year=9;
if prevn in (111,114,117,120) then last_year=10;
run;

data events20;
 merge lastevent prior_to_deact10;
  by studyid;

run;

proc sort data=derive.meduse_byyear out=meduse_byyear; by studyid year; run;

data meduse_byyear10;
 merge meduse_byyear events20;
  by studyid;

  *Set to missing instances where participant was not active during any part of a specific year following deactivation;
  if p_status eq "inactive" and year gt last_year then do;
    albut_broncho = .;
    analgesics_oral = .;
    analgesics_topical = .;
    antibiot_oral = .;
    antibiot_topical = .;
    antifung_oral = .;
    antifung_topical = .; 
    antihist_oral = .; 
    antihist_topical = .; 
    antileuk = .;
    cough_meds = .; 
    cromones = .;
    decongest = .;
    gi_meds = .;
    LABA = .;
    nasalspray_noster = .;
    nasalspray_ster = .;
    steroid_inhaled = .;
    steroid_oral = .;
    steroid_topical = .;
    ophthals = .;
    otological = .;
    epinephrine = .;
    vitamin = .;
    antiviral_oral = .;
    inhaled_steroid_LABA = .; 
    combo_antihist = .;
    combo_nonantihist = .;
    cold_preps = .;
    other_topical = .;
    other_inhale = .;
    other_oral = .;
    other_route_unknown = .;
 end;
run;

*Replace previously derived meduse_byyear dataset with updated dataset;
data derive.meduse_byyear;
 set meduse_byyear10;

 drop avisit quarter;
run;

ods rtf style=journal file="S:\RhoFED\ICAC\Studies\URECA\Prog\Derive\MedUse_by_Year_Freq_&sysdate..rtf" notoc_data;
proc freq data=meduse_byyear10;
   tables albut_broncho -- other_route_unknown * year/norow;
run;
ods rtf close;



*** Codebook ****************************************************************;

%include 'S:\BASESTAT\RhoUtil\gitGot.sas';
    %gitGot
        (repo = https://github.com/RhoInc/sas-codebook
        ,folder = Macros);

%codebook_generic
        (data = derive.meduse_byyear
        ,pdfpath = S:/RhoFED/ICAC/Studies/URECA/Data/Derive/CBK);

